generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ConversationType {
  DIRECT
  GROUP
}

enum ParticipantRole {
  MEMBER
  ADMIN
}

model Conversation {
  id          String            @id @default(uuid())
  type        ConversationType
  title       String?           // for GROUP chats
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  participants Participant[]
  messages     Message[]

  @@index([type])
  @@index([updatedAt])
}

model Participant {
  id             String          @id @default(uuid())
  conversationId String
  userId         String          // user-service userId (stored as string)
  role           ParticipantRole @default(MEMBER)
  joinedAt       DateTime        @default(now())

  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])  // user can join a conversation only once
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String       // userId of sender (from user-service)
  body           String
  metadata       Json?        // optional: attachments info, links, etc.
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
}